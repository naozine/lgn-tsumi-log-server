package components

import (
    "fmt"
    "github.com/naozine/project_crud_with_auth_tmpl/internal/database"
    "github.com/naozine/project_crud_with_auth_tmpl/internal/appcontext"
)

templ ProjectDetail(lp database.Project, devices []database.Device, courses []string) {
    {{
        userRole := appcontext.GetUserRole(ctx)
    }}
    <div class="max-w-3xl mx-auto">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold tracking-tight text-gray-900">{ lp.Name }</h2>
                <p class="mt-1 text-sm text-gray-500">ID: { fmt.Sprintf("%d", lp.ID) } â€¢ ä½œæˆæ—¥: { lp.CreatedAt.Time.Format("2006/01/02 15:04") }</p>
            </div>
            if userRole == "admin" || userRole == "editor" {
                <div class="flex space-x-3">
                    <a href={ templ.URL(fmt.Sprintf("/projects/%d/edit", lp.ID)) } class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2">
                        ç·¨é›†
                    </a>
                    <form action={ templ.URL(fmt.Sprintf("/projects/%d/delete", lp.ID)) } method="POST" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                        <button type="submit" class="inline-flex items-center justify-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                            å‰Šé™¤
                        </button>
                    </form>
                </div>
            }
        </div>

        <div class="bg-white shadow sm:rounded-lg border border-gray-200">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900">æ¡ˆä»¶è¨­å®š</h3>
                <div class="mt-2 text-sm text-gray-500 space-y-1">
                    <p>åˆ°ç€åˆ¤å®šè·é›¢: <span class="font-medium text-gray-900">{ fmt.Sprintf("%d", lp.ArrivalThresholdMeters.Int64) }</span> m</p>
                    <p>åˆ¤å®šæ»åœ¨æ™‚é–“: <span class="font-medium text-gray-900">{ fmt.Sprintf("%d", lp.JudgeStayTimeMinutes.Int64) }</span> åˆ†</p>
                    <p>åˆ¤å®šé€Ÿåº¦ä¸Šé™: <span class="font-medium text-gray-900">{ fmt.Sprintf("%.1f", lp.JudgeSpeedLimitKmh.Float64) }</span> km/h</p>
                </div>
                if userRole == "admin" || userRole == "editor" {
                     <div class="mt-6 border-t border-gray-100 pt-4">
                        @APIKeyDisplay(lp)
                     </div>
                }
            </div>
        </div>

        <div class="mt-8 bg-white shadow sm:rounded-lg border border-gray-200">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">é…é€ãƒ«ãƒ¼ãƒˆ</h3>
                    if userRole == "admin" || userRole == "editor" {
                        <a href={ templ.URL(fmt.Sprintf("/projects/%d/courses/upload", lp.ID)) }
                           class="inline-flex items-center rounded-md bg-black px-3 py-2 text-sm text-white hover:bg-gray-800 transition-colors">
                            CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        </a>
                    }
                </div>

                if lp.CsvFilename.Valid {
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ“„</span>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-gray-900">{ lp.CsvFilename.String }</h4>
                                <p class="text-xs text-gray-500 mt-1">
                                    { lp.CsvImportedAt.Time.Format("2006/01/02 15:04") } ã‚¤ãƒ³ãƒãƒ¼ãƒˆ â€¢
                                    { fmt.Sprintf("%d", lp.CsvRowCount.Int64) } ä»¶
                                </p>
                            </div>
                        </div>
                    </div>
                    <a href={ templ.URL(fmt.Sprintf("/projects/%d/courses", lp.ID)) }
                       class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-900">
                        ã‚³ãƒ¼ã‚¹ä¸€è¦§ã‚’è¦‹ã‚‹ â†’
                    </a>
                } else {
                    <p class="text-sm text-gray-500">ã¾ã é…é€ãƒ«ãƒ¼ãƒˆãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                }
            </div>
        </div>

        <!-- ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-8 bg-white shadow sm:rounded-lg border border-gray-200">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">ç™»éŒ²ãƒ‡ãƒã‚¤ã‚¹</h3>
                </div>

                if len(devices) > 0 {
                    <div class="overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ‡ãƒã‚¤ã‚¹</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‹…å½“ã‚³ãƒ¼ã‚¹</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€çµ‚é€šä¿¡</th>
                                    if userRole == "admin" || userRole == "editor" {
                                        <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                    }
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                for _, device := range devices {
                                    <tr>
                                        <td class="px-3 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">
                                                if device.DeviceName.Valid && device.DeviceName.String != "" {
                                                    { device.DeviceName.String }
                                                } else {
                                                    <span class="text-gray-500">ï¼ˆåå‰ãªã—ï¼‰</span>
                                                }
                                            </div>
                                            <div class="text-xs text-gray-500 font-mono">{ device.DeviceID }</div>
                                        </td>
                                        <td class="px-3 py-4 whitespace-nowrap">
                                            if userRole == "admin" || userRole == "editor" {
                                                <form action={ templ.URL(fmt.Sprintf("/projects/%d/devices/%s/assign", lp.ID, device.DeviceID)) } method="POST" class="flex items-center space-x-2">
                                                    <select name="course_name" class="block w-40 rounded-md border-gray-300 text-sm focus:border-black focus:ring-black">
                                                        <option value="">-- æœªå‰²å½“ --</option>
                                                        for _, course := range courses {
                                                            if device.CourseName.Valid && device.CourseName.String == course {
                                                                <option value={ course } selected>{ course }</option>
                                                            } else {
                                                                <option value={ course }>{ course }</option>
                                                            }
                                                        }
                                                    </select>
                                                    <button type="submit" class="text-xs text-indigo-600 hover:text-indigo-900">ä¿å­˜</button>
                                                </form>
                                            } else {
                                                if device.CourseName.Valid && device.CourseName.String != "" {
                                                    <span class="text-sm text-gray-900">{ device.CourseName.String }</span>
                                                } else {
                                                    <span class="text-sm text-gray-500">æœªå‰²å½“</span>
                                                }
                                            }
                                        </td>
                                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                                            if device.LastSeenAt.Valid {
                                                { device.LastSeenAt.Time.Format("01/02 15:04") }
                                            } else {
                                                -
                                            }
                                        </td>
                                        if userRole == "admin" || userRole == "editor" {
                                            <td class="px-3 py-4 whitespace-nowrap text-right text-sm">
                                                <form action={ templ.URL(fmt.Sprintf("/projects/%d/devices/%s/delete", lp.ID, device.DeviceID)) } method="POST" onsubmit="return confirm('ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" class="inline">
                                                    <button type="submit" class="text-red-600 hover:text-red-900">å‰Šé™¤</button>
                                                </form>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                } else {
                    <p class="text-sm text-gray-500">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p class="text-xs text-gray-400 mt-1">ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰ POST /api/v1/devices ã‚’å‘¼ã³å‡ºã™ã¨è‡ªå‹•çš„ã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</p>
                }
            </div>
        </div>

        <div class="mt-6">
            <a href="/projects" class="text-sm font-medium text-gray-600 hover:text-gray-900">
                â† ä¸€è¦§ã«æˆ»ã‚‹
            </a>
        </div>
    </div>
}

templ APIKeyDisplay(p database.Project) {
    <div id="api-key-section">
        <label class="block text-sm font-medium text-gray-700">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±é€šAPIã‚­ãƒ¼</label>
        <div class="mt-1 flex rounded-md shadow-sm">
            <div class="relative flex flex-grow items-stretch focus-within:z-10">
                <input type="text" readonly value={ p.ApiKey } class="block w-full rounded-none rounded-l-md border-gray-300 focus:border-black focus:ring-black sm:text-sm bg-gray-50 text-gray-600 font-mono" />
            </div>
            <button hx-post={ fmt.Sprintf("/projects/%d/api-key", p.ID) }
                    hx-target="#api-key-section"
                    hx-swap="outerHTML"
                    hx-confirm="APIã‚­ãƒ¼ã‚’å†ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\nå¤ã„ã‚­ãƒ¼ã¯å³åº§ã«ä½¿ç”¨ã§ããªããªã‚Šã¾ã™ã€‚\nç™»éŒ²æ¸ˆã¿ã®ç«¯æœ«è¨­å®šã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
                    type="button"
                    class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:border-black focus:outline-none focus:ring-1 focus:ring-black">
                <span>å†ç”Ÿæˆ</span>
            </button>
        </div>
        <p class="mt-2 text-xs text-gray-500">ã“ã®ã‚­ãƒ¼ã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªï¼ˆEMM/MDMè¨­å®šï¼‰ã‹ã‚‰ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆèªè¨¼ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
    </div>
}