package components

import (
	"fmt"
	"github.com/naozine/project_crud_with_auth_tmpl/internal/database"
)

// TruckStatusInfo ã¯ãƒˆãƒ©ãƒƒã‚¯ã®ç¾åœ¨çŠ¶æ³ï¼ˆã“ã®åœ°ç‚¹ã‹ã‚‰è¦‹ãŸï¼‰
type TruckStatusInfo struct {
	HasLocation        bool    // ä½ç½®æƒ…å ±ãŒã‚ã‚‹ã‹
	StopsAway          int     // ã“ã®åœ°ç‚¹ã¾ã§ã‚ã¨ä½•åœ°ç‚¹ã‹ï¼ˆè² ã®å ´åˆã¯é€šéæ¸ˆã¿ï¼‰
	CurrentStopName    string  // ãƒˆãƒ©ãƒƒã‚¯ãŒç¾åœ¨ã„ã‚‹åœ°ç‚¹ï¼ˆã¾ãŸã¯ç›´å‰ã«é€šéã—ãŸåœ°ç‚¹ï¼‰
	DelayMinutes       int     // äºˆå®šã‹ã‚‰ã®é…ã‚Œï¼ˆæ­£: é…ã‚Œã€è² : æ—©ã„ï¼‰
	LastArrivedStop    string  // æœ€å¾Œã«åˆ°ç€ã—ãŸåœ°ç‚¹å
	LastArrivedTime    string  // æœ€å¾Œã«åˆ°ç€ã—ãŸæ™‚åˆ»ï¼ˆå®Ÿç¸¾ï¼‰
	LastDepartedTime   string  // æœ€å¾Œã«åˆ°ç€ã—ãŸåœ°ç‚¹ã®å‡ºç™ºæ™‚åˆ»ï¼ˆå®Ÿç¸¾ï¼‰
	ScheduledTime      string  // æœ€å¾Œã«åˆ°ç€ã—ãŸåœ°ç‚¹ã®äºˆå®šæ™‚åˆ»
	DistanceKm         float64 // ã“ã®åœ°ç‚¹ã¾ã§ã®è·é›¢ï¼ˆkmï¼‰
	IsWithinRange      bool    // åˆ¤å®šç¯„å›²å†…ã‹ã©ã†ã‹
}

// StopTruckStatus ã¯ãƒˆãƒ©ãƒƒã‚¯çŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆhtmx pollingç”¨ï¼‰
templ StopTruckStatus(truckStatus *TruckStatusInfo) {
	if truckStatus != nil && truckStatus.HasLocation {
		<div class="mb-6 bg-white shadow sm:rounded-lg border border-gray-200 p-4">
			<div class="flex items-center mb-3">
				<span class="text-xl mr-2">ğŸš›</span>
				<h3 class="text-lg font-semibold text-gray-900">ãƒˆãƒ©ãƒƒã‚¯çŠ¶æ³</h3>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<!-- ä½•åœ°ç‚¹å‰ã«ã„ã‚‹ã‹ -->
				<div class="bg-gray-50 rounded-lg p-3">
					<p class="text-xs text-gray-500 mb-1">ç¾åœ¨ä½ç½®</p>
					if truckStatus.StopsAway == 1 {
						<p class="text-sm font-medium text-blue-600">
							<span class="text-lg font-bold">ã“ã®åœ°ç‚¹ã«å‘ã‹ã£ã¦ã„ã¾ã™</span>
						</p>
						if truckStatus.CurrentStopName != "" {
							<p class="text-xs text-gray-600 mt-1">{ truckStatus.CurrentStopName } ã‹ã‚‰ç§»å‹•ä¸­</p>
						}
					} else if truckStatus.StopsAway > 1 {
						<p class="text-sm font-medium text-gray-900">
							ã“ã®åœ°ç‚¹ã® <span class="text-lg font-bold text-blue-600">{ fmt.Sprintf("%d", truckStatus.StopsAway) }</span> ã¤å‰
						</p>
						if truckStatus.CurrentStopName != "" {
							<p class="text-xs text-gray-600 mt-1">{ truckStatus.CurrentStopName } ä»˜è¿‘</p>
						}
					} else if truckStatus.StopsAway == 0 {
						<p class="text-sm font-medium text-green-600">
							<span class="text-lg font-bold">ã“ã®åœ°ç‚¹ã«åˆ°ç€æ¸ˆã¿</span>
						</p>
					} else {
						<p class="text-sm font-medium text-gray-600">
							ã“ã®åœ°ç‚¹ã¯é€šéæ¸ˆã¿ï¼ˆ{ fmt.Sprintf("%d", -truckStatus.StopsAway) } ã¤å…ˆã¸ç§»å‹•ï¼‰
						</p>
					}
				</div>

				<!-- ã“ã®åœ°ç‚¹ã¾ã§ã®è·é›¢ -->
				<div class={ "rounded-lg p-3", templ.KV("bg-green-50 border border-green-200", truckStatus.IsWithinRange), templ.KV("bg-gray-50", !truckStatus.IsWithinRange) }>
					<p class="text-xs text-gray-500 mb-1">ã“ã®åœ°ç‚¹ã¾ã§ã®è·é›¢</p>
					if truckStatus.StopsAway <= 0 {
						<p class="text-sm font-medium text-green-600">åˆ°ç€æ¸ˆã¿</p>
					} else if truckStatus.IsWithinRange {
						<p class="text-sm font-bold text-green-700">
							ç¯„å›²å†… ({ fmt.Sprintf("%.0f", truckStatus.DistanceKm * 1000) } m)
						</p>
					} else if truckStatus.DistanceKm < 1.0 {
						<p class="text-sm font-medium text-gray-900">
							ã‚ã¨ <span class="text-lg font-bold text-blue-600">{ fmt.Sprintf("%.0f", truckStatus.DistanceKm * 1000) }</span> m
						</p>
					} else {
						<p class="text-sm font-medium text-gray-900">
							ã‚ã¨ <span class="text-lg font-bold text-blue-600">{ fmt.Sprintf("%.2f", truckStatus.DistanceKm) }</span> km
						</p>
					}
				</div>

				<!-- é…ã‚Œ/æ—©ç€ -->
				<div class="bg-gray-50 rounded-lg p-3">
					<p class="text-xs text-gray-500 mb-1">é€²æ—çŠ¶æ³</p>
					if truckStatus.LastArrivedStop != "" && truckStatus.LastArrivedTime != "" {
						if truckStatus.DelayMinutes > 0 {
							<p class="text-sm font-medium text-red-600">
								äºˆå®šã‚ˆã‚Š <span class="text-lg font-bold">{ fmt.Sprintf("%d", truckStatus.DelayMinutes) }</span> åˆ†é…ã‚Œ
							</p>
						} else if truckStatus.DelayMinutes < 0 {
							<p class="text-sm font-medium text-green-600">
								äºˆå®šã‚ˆã‚Š <span class="text-lg font-bold">{ fmt.Sprintf("%d", -truckStatus.DelayMinutes) }</span> åˆ†æ—©ã„
							</p>
							
						} else {
							<p class="text-sm font-medium text-gray-900">
								äºˆå®šé€šã‚Š
							</p>
						}
						<p class="text-xs text-gray-600 mt-1">
							{ truckStatus.LastArrivedStop }: äºˆå®š { truckStatus.ScheduledTime } â†’ åˆ°ç€ { truckStatus.LastArrivedTime }
							if truckStatus.LastDepartedTime != "" {
								 â†’ å‡ºç™º { truckStatus.LastDepartedTime }
							}
						</p>
					} else {
						<p class="text-sm text-gray-500">ã¾ã åˆ°ç€ã—ãŸåœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>
					}
				</div>
			</div>
		</div>
	} else if truckStatus != nil && !truckStatus.HasLocation {
		<div class="mb-6 bg-gray-50 sm:rounded-lg border border-gray-200 p-4 text-center">
			<p class="text-sm text-gray-500">ãƒˆãƒ©ãƒƒã‚¯ã®ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
		</div>
	}
}

// StopDetail ã¯åœ°ç‚¹è©³ç´°ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
templ StopDetail(projectID int64, courseName string, stopID int64, stop database.RouteStop, truckStatus *TruckStatusInfo, timings map[int64]*StopTiming) {
	<div class="max-w-3xl mx-auto">
		<div class="mb-4">
			<a href={ templ.URL(fmt.Sprintf("/projects/%d/courses/%s", projectID, courseName)) }
			   class="text-sm font-medium text-gray-600 hover:text-gray-900">
				â† ã‚³ãƒ¼ã‚¹è©³ç´°ã«æˆ»ã‚‹
			</a>
		</div>

		<div class="mb-6">
			<div class="flex items-center mb-2">
				<span class="text-3xl mr-3">ğŸ“</span>
				<h2 class="text-2xl font-bold text-gray-900">{ stop.StopName }</h2>
			</div>
			<p class="mt-1 text-sm text-gray-500">
				ã‚³ãƒ¼ã‚¹: { courseName } â€¢ é †ç•ª: { stop.Sequence }
			</p>
		</div>

		<!-- ãƒˆãƒ©ãƒƒã‚¯çŠ¶æ³ï¼ˆhtmx polling: 5ç§’ã”ã¨ã«æ›´æ–°ï¼‰ -->
		<div id="stop-truck-status"
			 hx-get={ templ.URL(fmt.Sprintf("/projects/%d/courses/%s/stops/%d/status", projectID, courseName, stopID)) }
			 hx-trigger="every 5s"
			 hx-swap="innerHTML">
			@StopTruckStatus(truckStatus)
		</div>

		<div class="bg-white shadow sm:rounded-lg border border-gray-200 overflow-hidden">
			<div class="px-4 py-5 sm:p-6">
				<dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
					<!-- åˆ°ç€äºˆå®š -->
					<div>
						<dt class="text-sm font-medium text-gray-500">åˆ°ç€äºˆå®š</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if stop.ArrivalTime.Valid && stop.ArrivalTime.String != "" {
								{ stop.ArrivalTime.String }
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>

					<!-- åˆ°ç€å®Ÿç¸¾ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">åˆ°ç€å®Ÿç¸¾</dt>
						<dd class="mt-1 text-sm font-bold text-gray-900">
							if timings[stop.ID] != nil && timings[stop.ID].ArrivalTimeStr() != "" {
								{ timings[stop.ID].ArrivalTimeStr() }
							} else {
								<span class="text-gray-400 font-normal">-</span>
							}
						</dd>
					</div>

					<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
						<dd class="mt-1 text-sm">
							if timings[stop.ID] != nil && timings[stop.ID].Arrived {
								<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
									âœ“ åˆ°ç€æ¸ˆ
								</span>
							} else {
								<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
									æœªè¨ªå•
								</span>
							}
						</dd>
					</div>

					<!-- ä½æ‰€ -->
					<div class="sm:col-span-2">
						<dt class="text-sm font-medium text-gray-500">ä½æ‰€</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if stop.Address.Valid && stop.Address.String != "" {
								{ stop.Address.String }
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>

					<!-- ç·¯åº¦ãƒ»çµŒåº¦ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">ç·¯åº¦</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if stop.Latitude.Valid {
								{ fmt.Sprintf("%.6f", stop.Latitude.Float64) }
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>
					<div>
						<dt class="text-sm font-medium text-gray-500">çµŒåº¦</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if stop.Longitude.Valid {
								{ fmt.Sprintf("%.6f", stop.Longitude.Float64) }
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>

					<!-- æ»åœ¨äºˆå®š -->
					<div>
						<dt class="text-sm font-medium text-gray-500">æ»åœ¨äºˆå®š</dt>
						<dd class="mt-1 text-sm text-gray-900">
							{ fmt.Sprintf("%d", stop.StayMinutes.Int64) }åˆ†
						</dd>
					</div>

					<!-- æ»åœ¨å®Ÿç¸¾ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">æ»åœ¨å®Ÿç¸¾</dt>
						<dd class="mt-1 text-sm font-bold text-gray-900">
							if timings[stop.ID] != nil {
								{ timings[stop.ID].StayDurationStr() }
							} else {
								<span class="text-gray-400 font-normal">-</span>
							}
						</dd>
					</div>

					<!-- å‡ºç™ºå®Ÿç¸¾ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">å‡ºç™ºå®Ÿç¸¾</dt>
						<dd class="mt-1 text-sm font-bold text-gray-900">
							if timings[stop.ID] != nil && timings[stop.ID].DepartureTimeStr() != "" {
								{ timings[stop.ID].DepartureTimeStr() }
							} else {
								<span class="text-gray-400 font-normal">-</span>
							}
						</dd>
					</div>

					<!-- é‡é‡ -->
					<div>
						<dt class="text-sm font-medium text-gray-500">é‡é‡</dt>
						<dd class="mt-1 text-sm text-gray-900">
							{ fmt.Sprintf("%d", stop.WeightKg.Int64) }kg
						</dd>
					</div>

					<!-- é›»è©±ç•ªå· -->
					<div class="sm:col-span-2">
						<dt class="text-sm font-medium text-gray-500">é›»è©±ç•ªå·</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if stop.PhoneNumber.Valid && stop.PhoneNumber.String != "" {
								<a href={ templ.URL("tel:" + stop.PhoneNumber.String) } class="text-blue-600 hover:text-blue-800">
									{ stop.PhoneNumber.String }
								</a>
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>

					<!-- å¸Œæœ›æ™‚é–“å¸¯ -->
					<div class="sm:col-span-2">
						<dt class="text-sm font-medium text-gray-500">å¸Œæœ›æ™‚é–“å¸¯</dt>
						<dd class="mt-1 text-sm text-gray-900">
							if (stop.DesiredTimeStart.Valid && stop.DesiredTimeStart.String != "") || (stop.DesiredTimeEnd.Valid && stop.DesiredTimeEnd.String != "") {
								if stop.DesiredTimeStart.Valid && stop.DesiredTimeStart.String != "" {
									{ stop.DesiredTimeStart.String }
								}
								ã€œ
								if stop.DesiredTimeEnd.Valid && stop.DesiredTimeEnd.String != "" {
									{ stop.DesiredTimeEnd.String }
								}
							} else {
								<span class="text-gray-400">-</span>
							}
						</dd>
					</div>

					<!-- å‚™è€ƒ -->
					if (stop.Note1.Valid && stop.Note1.String != "") || (stop.Note2.Valid && stop.Note2.String != "") || (stop.Note3.Valid && stop.Note3.String != "") {
						<div class="sm:col-span-2">
							<dt class="text-sm font-medium text-gray-500">å‚™è€ƒ</dt>
							<dd class="mt-1 text-sm text-gray-900 space-y-1">
								if stop.Note1.Valid && stop.Note1.String != "" {
									<p>{ stop.Note1.String }</p>
								}
								if stop.Note2.Valid && stop.Note2.String != "" {
									<p>{ stop.Note2.String }</p>
								}
								if stop.Note3.Valid && stop.Note3.String != "" {
									<p>{ stop.Note3.String }</p>
								}
							</dd>
						</div>
					}
				</dl>
			</div>
		</div>

		<!-- Google Maps ãƒªãƒ³ã‚¯ -->
		if stop.Latitude.Valid && stop.Longitude.Valid {
			<div class="mt-6">
				<a href={ templ.URL(fmt.Sprintf("https://www.google.com/maps?q=%f,%f", stop.Latitude.Float64, stop.Longitude.Float64)) }
				   target="_blank"
				   rel="noopener noreferrer"
				   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
					<span class="mr-2">ğŸ—ºï¸</span>
					Google Mapsã§é–‹ã
				</a>
			</div>
		}
	</div>
}
