package components

import (
    "fmt"
    "time"
    "github.com/naozine/project_crud_with_auth_tmpl/internal/database"
    "github.com/naozine/project_crud_with_auth_tmpl/internal/status"
)

// JST ã¯æ—¥æœ¬æ¨™æº–æ™‚
var JST = time.FixedZone("Asia/Tokyo", 9*60*60)

// CurrentLocationInfo ã¯ç¾åœ¨ä½ç½®ã¨èµ°è¡ŒåŒºé–“æƒ…å ±
type CurrentLocationInfo struct {
    Latitude       float64
    Longitude      float64
    Timestamp      time.Time
    SpeedMps       float64   // é€Ÿåº¦ï¼ˆm/sï¼‰

    // å‡ºç™ºåœ°ç‚¹ï¼ˆæœ€å¾Œã«åˆ°ç€ã—ãŸåœ°ç‚¹ï¼‰
    FromStop       string
    FromStopIdx    int

    // ç›®çš„åœ°ç‚¹ï¼ˆæ¬¡ã®æœªåˆ°ç€åœ°ç‚¹ï¼‰
    ToStop         string
    ToStopIdx      int
    ToDistanceKm   float64
    ToEtaMinutes   float64   // åˆ°ç€äºˆæƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰

    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
    NearestStop    string
    NearestStopIdx int
    DistanceKm     float64
    NextStop       string
    NextStopIdx    int
    NextDistanceKm float64
}

// CourseLocationStatus ã¯ç¾åœ¨ä½ç½®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆhtmx pollingç”¨ï¼‰
templ CourseLocationStatus(lpID int64, courseName string, stops []database.RouteStop, currentLocation *CurrentLocationInfo) {
    if currentLocation != nil {
        <div class="mb-6 bg-white shadow sm:rounded-lg border border-gray-200 p-4">
            <div class="flex items-center mb-3">
                <span class="text-xl mr-2">ğŸš›</span>
                <h3 class="text-lg font-semibold text-gray-900">ç¾åœ¨ã®èµ°è¡ŒçŠ¶æ³</h3>
            </div>

            <!-- ç§»å‹•ä¸­ã®åŒºé–“è¡¨ç¤º -->
            if currentLocation.FromStop != "" && currentLocation.ToStop != "" {
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm font-medium text-blue-900">
                        { currentLocation.FromStop } â†’ { currentLocation.ToStop } ã¸ç§»å‹•ä¸­
                    </p>
                </div>
            }

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- æ¬¡ã®ç›®çš„åœ° -->
                if currentLocation.ToStop != "" {
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">æ¬¡ã®ç›®çš„åœ°</p>
                        <p class="text-sm font-medium text-gray-900">{ currentLocation.ToStop }</p>
                        <p class="text-xs text-gray-600">ç´„ { fmt.Sprintf("%.2f", currentLocation.ToDistanceKm) } km</p>
                    </div>
                }

                <!-- åˆ°ç€äºˆæƒ³æ™‚é–“ -->
                if currentLocation.ToEtaMinutes > 0 {
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">åˆ°ç€äºˆæƒ³</p>
                        <p class="text-sm font-medium text-gray-900">ç´„ { fmt.Sprintf("%.0f", currentLocation.ToEtaMinutes) } åˆ†å¾Œ</p>
                        <p class="text-xs text-gray-600">é€Ÿåº¦ { fmt.Sprintf("%.0f", currentLocation.SpeedMps * 3.6) } km/h</p>
                    </div>
                }

                <!-- æœ€çµ‚æ›´æ–° -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500 mb-1">æœ€çµ‚æ›´æ–°</p>
                    <p class="text-sm font-medium text-gray-900">{ currentLocation.Timestamp.In(JST).Format("15:04:05") }</p>
                </div>
            </div>
        </div>
    } else {
        <div class="mb-6 bg-gray-50 sm:rounded-lg border border-gray-200 p-4 text-center">
            <p class="text-sm text-gray-500">ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    }

    <div class="bg-white shadow sm:rounded-lg border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é †ç•ª</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ°ç€æ™‚åˆ»</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½æ‰€</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ»åœ¨</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡é‡</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    for i, stop := range stops {
                        <tr class={
                            templ.KV("bg-green-50", stop.Status.String == status.Arrived),
                            templ.KV("bg-blue-50", currentLocation != nil && i == currentLocation.ToStopIdx && stop.Status.String != status.Arrived),
                            templ.KV("hover:bg-gray-50", stop.Status.String != status.Arrived && (currentLocation == nil || i != currentLocation.ToStopIdx)),
                        }>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">
                                if stop.Status.String == status.Arrived {
                                    <span class="mr-1 text-green-600">âœ“</span>
                                } else if currentLocation != nil && i == currentLocation.ToStopIdx {
                                    <span class="mr-1">ğŸ“</span>
                                }
                                { stop.Sequence }
                            </td>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">{ stop.ArrivalTime.String }</td>
                            <td class="px-4 py-3 text-sm font-medium">
                                <a href={ templ.URL(fmt.Sprintf("/logistics/projects/%d/courses/%s/stops/%d", lpID, courseName, stop.ID)) }
                                   class="text-blue-600 hover:text-blue-800 hover:underline">
                                    { stop.StopName }
                                </a>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">{ stop.Address.String }</td>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">{ fmt.Sprintf("%d", stop.StayMinutes.Int64) }åˆ†</td>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">{ fmt.Sprintf("%d", stop.WeightKg.Int64) }kg</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

templ CourseDetail(lp database.LogisticsProject, courseName string, stops []database.RouteStop, currentLocation *CurrentLocationInfo) {
    <div class="max-w-5xl mx-auto">
        <div class="mb-6">
            <div class="flex items-center mb-2">
                <span class="text-3xl mr-3">ğŸš›</span>
                <h2 class="text-2xl font-bold text-gray-900">{ courseName }</h2>
            </div>
            <p class="mt-1 text-sm text-gray-500">
                æ¡ˆä»¶: { lp.Name } â€¢ ç·åœè»Šåœ°ç‚¹æ•°: { fmt.Sprintf("%d", len(stops)) }
            </p>
        </div>

        <!-- htmx polling: 5ç§’ã”ã¨ã«ç¾åœ¨ä½ç½®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–° -->
        <div id="course-location-status"
             hx-get={ templ.URL(fmt.Sprintf("/logistics/projects/%d/courses/%s/location", lp.ID, courseName)) }
             hx-trigger="every 5s"
             hx-swap="innerHTML">
            @CourseLocationStatus(lp.ID, courseName, stops, currentLocation)
        </div>

        <div class="mt-6 flex items-center justify-between">
            <a href={ templ.URL(fmt.Sprintf("/logistics/projects/%d/courses", lp.ID)) }
               class="text-sm font-medium text-gray-600 hover:text-gray-900">
                â† ã‚³ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹
            </a>
            <div class="flex items-center gap-4">
                <form action={ templ.URL(fmt.Sprintf("/logistics/projects/%d/courses/%s/reset", lp.ID, courseName)) }
                      method="POST"
                      onsubmit="return confirm('åˆ°ç€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ');">
                    <button type="submit"
                            class="text-sm font-medium text-orange-600 hover:text-orange-800">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </form>
                <a href={ templ.URL(fmt.Sprintf("/logistics/projects/%d", lp.ID)) }
                   class="text-sm font-medium text-gray-600 hover:text-gray-900">
                    æ¡ˆä»¶è©³ç´°ã«æˆ»ã‚‹ â†’
                </a>
            </div>
        </div>
    </div>
}
